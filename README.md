# SWS Interview Demo

A Next.js App Router demo built for Stanford Web Services. Explores headless CMS integration,
secure editor preview, GraphQL with code generation, server-side caching with on-demand
revalidation, and WCAG AA accessibility patterns.

## Getting Started

### 1. Set up environment variables

```bash
cp .env.example .env.local
```

Fill in `.env.local`. At minimum you need:

| Variable | Where to find it |
|----------|-----------------|
| `STORYBLOK_PUBLIC_ACCESS_TOKEN` | Storyblok → Settings → Access Tokens |
| `STORYBLOK_PREVIEW_ACCESS_TOKEN` | Storyblok → Settings → Access Tokens |
| `NEXT_PUBLIC_STORYBLOK_ACCESS_TOKEN` | Same as public token above |
| `STORYBLOK_SPACE_ID` | Storyblok → Settings → General |
| `REVALIDATE_SECRET` | Any long random string you choose |

### 2. Install dependencies

```bash
npm install
```

### 3. Start the development server

```bash
npm run dev
```

Open [http://localhost:3000](http://localhost:3000).

To test the Storyblok Visual Editor locally, HTTPS is required:

```bash
npx next dev --experimental-https
```

Then set the preview URL in your Storyblok space to `https://localhost:3000/editor`.

## Scripts

| Script | Description |
|--------|-------------|
| `npm run dev` | Development server (Turbopack) |
| `npm run build` | Production build |
| `npm start` | Start the production build |
| `npm run lint` | ESLint + TypeScript checks |
| `npm run codegen` | Regenerate GraphQL types from Storyblok schema |

## Storyblok Content

Stories live under a `site/` folder in Storyblok. Each story maps directly to a URL:

```
site/accessibility-lab  →  /accessibility-lab
site/cache-revalidation-lab  →  /cache-revalidation-lab
```

The Visual Editor preview URL should point to:
```
https://<your-domain>/editor
```

## GraphQL

Queries are defined as `.graphql` files in `src/lib/gql/queries/`. A type-safe SDK is generated by
[GraphQL Code Generator](https://the-guild.dev/graphql/codegen) using
[graphql-request](https://github.com/jasonkuhrt/graphql-request) and committed at
`src/lib/gql/generated.ts`. To regenerate after modifying a query:

```bash
npm run codegen
```

> Requires `STORYBLOK_GRAPHQL_TOKEN` and a Storyblok Enterprise plan to introspect the schema.
> The committed `generated.ts` is pre-generated for the demo since the free plan does not expose
> the GraphQL API.

## Cache

CMS pages are statically generated at build time via `generateStaticParams`. The `/gql-demo` route
caches its GraphQL response using the `'use cache'` directive with `cacheTag` and `cacheLife`.

Two API endpoints support on-demand cache busting:

```
POST /api/revalidate?secret=<REVALIDATE_SECRET>&tag=<tag>
POST /api/revalidate/page?secret=<REVALIDATE_SECRET>&path=<path>
```

The `/gql-demo` page has an interactive panel to trigger these and observe the cached timestamp change.

For automatic invalidation on content publish, configure a Storyblok webhook pointing to:

```
POST /api/webhook/storyblok
```

### Cache tags

| Tag | Scope |
|-----|-------|
| `storyblok` | All CMS pages and GraphQL responses |
| `story:<slug>` | A single CMS page |
| `gql-articles` | The `/gql-demo` articles query only |

## Architecture

```
src/
  app/
    (site)/             Public pages with site chrome (header / footer / skip link)
      page.tsx          Static landing page
      [...slug]/        Storyblok CMS pages (SSG via generateStaticParams)
      gql-demo/         GraphQL + cache demo (interactive)
    (editor)/           Storyblok Visual Editor — no site chrome
      editor/           SHA-1 token verification + draft preview
    api/
      revalidate/       Tag and path revalidation endpoints
      webhook/storyblok Webhook handler (HMAC-SHA1 signature verification)
  components/
    storyblok/          One React component per Storyblok blok type
    ui/                 Shared UI components
  lib/
    gql/                graphql-request client, generated types, .graphql query files
    storyblok/          CMS fetch client, component registry, token verification
    env/                Zod-validated environment variables
```

## Deploy on Vercel

Set all variables from `.env.example` in your Vercel project settings, then deploy normally.
Point the Storyblok webhook at your production domain:

```
https://<your-vercel-domain>/api/webhook/storyblok
```
